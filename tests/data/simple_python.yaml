resource_types:
  - name: cf-ci-credentials
    type: docker-image
    source:
      repository: vwdilab-docker.jfrog.io/vws-credentials-resource
      tag: latest

  - name: cf-cli
    type: docker-image
    source:
      repository: nulldriver/cf-cli-resource
      tag: latest

  - name: pull-request
    type: docker-image
    source:
      repository: teliaoss/github-pr-resource
      tag: latest


resources:
  - name: src
    type: git
    icon: git
    check_every: 24h
    webhook_token: ((webhook-token))
    source:
      uri: git@github.com:vw-sre/simple-release.git
      branch: master
      private_key: ((sre_git_key))

  - name: pull-request-dependency-update
    type: pull-request
    icon: source-merge
    check_every: 24h
    webhook_token: ((webhook-token))
    source:
      repository: vw-sre/simple-release
      access_token: ((sre_git_access_token))

  - name: emea-cf-devtools-production-user
    type: cf-ci-credentials
    icon: account-clock-outline
    source:
      client_id: ((client_id))
      client_secret: ((client_secret))
      token_url: ((token_url))
      credentials_endpoint: ((credentials_endpoint))

  - name: cf-production
    type: cf-cli
    source:
      cf_dial_timeout: 300

jobs:
  - name: dependency-unittest
    plan:
    - get: pull-request-dependency-update
      trigger: true
      version: every
    - put: pull-request-dependency-update
      params:
        path: pull-request-dependency-update
        status: pending
    - task: pytest
      input_mapping:
        src: pull-request-dependency-update
      file: pull-request-dependency-update/ci/test.yml
      on_failure:
        put: pull-request-dependency-update
        params:
          path: pull-request-dependency-update
          status: failure
    - put: pull-request-dependency-update
      params:
        path: pull-request-dependency-update
        status: success

  - name: unittest
    plan:
    - get: src
      trigger: true
    - task: pytest
      file: src/ci/test.yml

  - name: deploy-emea
    serial: true
    plan:

    - get: src
      resource: src
      trigger: true
      passed: [unittest]

    - get: emea-cf-devtools-production-user

    - put: deploy
      resource: cf-production
      params:
        command: zero-downtime-push
        cf_home: emea-cf-devtools-production-user
        current_app_name: releasepage
        manifest: src/ci/manifest.yml
        path: src/.